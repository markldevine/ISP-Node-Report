#!/usr/bin/env raku

my $tz-off      = now.DateTime.local.timezone;

my $window-hour = 15;

my $now         = DateTime.new(:2024year, :07month :02day, :16hour, :00minute, :00second, :timezone($tz-off));
my $target      = $now;
$target         = DateTime.new(($now - (24 * 60 * 60))) if $now.hour < $window-hour;

my $year        = $target.local.year;
my $month       = $target.local.month;
my $day         = $target.local.day;

put 'Current date/time: ' ~ $now.local;

my $begin;
my $first;
loop (my $i = 0; $i < 10; $i++) {
    my $end     =   (DateTime.new(
                        :$year,
                        :$month,
                        :$day,
                        :hour($window-hour),
                        :00minute,
                        :00second,
                        :timezone($tz-off),
                     ) - ($i * (24 * 60 * 60))
                    );
    $begin      =   $end - (24 * 60 * 60);
    $first      = $begin if $i == 0;
    put "[$i]\t" ~ $begin.DateTime.local ~ ' ... ' ~ $end.DateTime.local;
}

put "\t" ~ $first.DateTime.local;

loop (my $i = 0; $i < 24; $i++) {
    my $data    =   DateTime.new(
                        :$year,
                        :$month,
                        :$day,
                        :hour($i),
                        :00minute,
                        :00second,
                        :timezone($tz-off),
                    ) - (2 * (24 * 60 * 60));
    my $result  = (($first - $data) / (24 * 60 * 60));
    if $result <= 0 {
        note 'Data DT ' ~ $data.DateTime.local ~ " is in the backup window's future!";
        next;
    }
    my $index   = $result.floor;
    $index++    if $index < $result;
    put "[$index]\t" ~ $data.DateTime.local ~ "\t\t" ~ $result;
}

=finish
